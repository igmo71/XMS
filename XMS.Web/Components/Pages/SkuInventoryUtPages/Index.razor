@page "/sku-inventory-ut"
@using Microsoft.AspNetCore.Authorization
@using XMS.Application.Abstractions.Services
@using XMS.Domain.Models
@implements IDisposable
@inject ISkuInventoryUtService Service
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Large">
	<MudPaper>
		<MudDataGrid Items="@_items"
					 Loading="@_isLoading"
					 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
					 Filterable="true"
					 Dense="true">
			<ToolBarContent>
				<MudText Typo="Typo.h5">Остатки товаров на складах (1С УТ)</MudText>
				<MudSpacer />
				<MudButton OnClick="ReloadDataFromOneSAsync" Color="Color.Primary" Variant="Variant.Filled">
					@if (_isReloading)
					{
						<MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
						<MudText Class="ms-2">Синхронизация...</MudText>
					}
					else
					{
						<MudIcon Icon="@Icons.Material.Filled.Sync" Class="me-2" />
						<MudText>Обновить из 1С</MudText>
					}
				</MudButton>
			</ToolBarContent>
			<Columns>
				@* <PropertyColumn Property="x => x.Id" Title="Id" /> *@
				<PropertyColumn Property="x => x.ScuId" Title="Номенклатура" />
				<PropertyColumn Property="x => x.WarehouseId" Title="Склад" />
				<PropertyColumn Property="x => x.QuantityOnHand" Title="В наличии" />
			</Columns>
			<LoadingContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Загрузка из БД...
				</MudAlert>
			</LoadingContent>
			<NoRecordsContent>
				<MudAlert Severity="Severity.Warning" ContentAlignment="HorizontalAlignment.Center" Class="mx-3">
					Остатки не найдены. Нажмите "Обновить", чтобы загрузить данные.
				</MudAlert>
			</NoRecordsContent>
			<PagerContent>
				<MudDataGridPager T="SkuInventoryUt" />
			</PagerContent>
		</MudDataGrid>
	</MudPaper>
</MudContainer>

@code {
	private readonly CancellationTokenSource _cts = new();
	private IEnumerable<SkuInventoryUt> _items = [];
	private bool _isLoading;
	private bool _isReloading;

	protected override async Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		if (_isLoading) return;

		_isLoading = true;
		try
		{
			_items = await Service.GetListAsync(_cts.Token);
		}
		finally
		{
			_isLoading = false;
			StateHasChanged();
		}
	}

	private async Task ReloadDataFromOneSAsync()
	{
		_isReloading = true;
		try
		{
			Snackbar.Add("Синхронизация с 1С...", Severity.Info);

			await Service.ReloadListAsync(_cts.Token);

			Snackbar.Add("Остатки успешно синхронизированы с 1С", Severity.Success);

			await LoadDataAsync();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Ошибка при обмене с 1С: {ex.Message}", Severity.Error);
		}
		finally
		{
			_isReloading = false;
		}
	}

	public void Dispose()
	{
		_cts.Cancel();
		_cts.Dispose();
		GC.SuppressFinalize(this);
	}
}
