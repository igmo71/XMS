@page "/locations"
@using Microsoft.AspNetCore.Authorization
@using XMS.Application.Abstractions.Services
@using XMS.Domain.Models
@using XMS.Web.Components.Common
@implements IDisposable
@inject ILocationService Service
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Medium">
	<MudPaper>
		<MudDataGrid @ref="_itemGrid"
					 T="Location"
					 Items="@_items"
					 Loading="@_isLoading"
					 EditMode="DataGridEditMode.Form"
					 EditTrigger="DataGridEditTrigger.Manual"
					 CommittedItemChanges="@((item) => CommittedItemChanges(item))"
					 ReadOnly="false"
					 Bordered="true"
					 Dense="true"
					 Hover="true"
					 Striped="true"
					 Filterable="true">
			<ToolBarContent>
				<MudText Typo="Typo.h5">Локации</MudText>
				<MudSpacer />
				<MudButtonGroup Class="ma-0 pa-0" Color="Color.Primary" Variant="Variant.Filled">
					<MudButton OnClick="NewItemAsync" StartIcon="@Icons.Material.Filled.Add">
						Добавить
					</MudButton>
				</MudButtonGroup>
			</ToolBarContent>
			<Columns>
				<PropertyColumn Property="x => x.Name" Title="Наименование">
					<CellTemplate>
						<MudText Class="@(context.Item.IsDeleted ? "text-secondary text-decoration-line-through" : "")">@context.Item.Name</MudText>
					</CellTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.IsDeleted" Title="Удален">
					<CellTemplate>
						<MudChip T="string" Color="@(context.Item.IsDeleted? Color.Secondary: Color.Info)" Size="Size.Small" Variant="Variant.Text">
							@(context.Item.IsDeleted ? "Удален" : "Активен")
						</MudChip>
					</CellTemplate>
				</PropertyColumn>
				<TemplateColumn>
					<CellTemplate>
						<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Color="Color.Primary" OnClick="@context.Actions.StartEditingItemAsync" title="Изменить" />
						@if (context.Item.IsDeleted)
						{
							<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.RestoreFromTrash" Color="Color.Info" OnClick="@(() => RestoreItemAsync(context.Item))" title="Восстановить" />
						}
						else
						{
							<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Secondary" OnClick="@(() => DeleteItemAsync(context.Item))" title="Удалить" />
						}
					</CellTemplate>
				</TemplateColumn>
			</Columns>
			<LoadingContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Загрузка из БД...
				</MudAlert>
			</LoadingContent>
			<NoRecordsContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Здесь пока ничего нет. Нажмите "Добавить", чтобы создать первый!
				</MudAlert>
			</NoRecordsContent>
			<PagerContent>
				<MudDataGridPager T="Location" />
			</PagerContent>
		</MudDataGrid>
	</MudPaper>
</MudContainer>

@code {
	private readonly CancellationTokenSource _cts = new();
	private IEnumerable<Location> _items = [];
	private MudDataGrid<Location> _itemGrid = default!;
	private bool _isLoading;
	private bool _isProcessing;
	private bool _includeDeleted = true;

	protected async override Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		_isLoading = true;
		try
		{
			_items = await Service.GetListAsync(_includeDeleted, _cts.Token);
		}
		finally
		{
			_isLoading = false;

			StateHasChanged();
		}
	}

	private async Task NewItemAsync()
	{
		var item = new Location();

		await _itemGrid.SetEditingItemAsync(item);
	}

	private async Task<DataGridEditFormAction> CommittedItemChanges(Location item)
	{
		try
		{
			if (!_items.Any(x => x.Id == item.Id))
				await Service.CreateAsync(item);
			else
				await Service.UpdateAsync(item);

			Snackbar.Add($"Успешно сохранено: {item.Name}", Severity.Success);

			await LoadDataAsync();

			return DataGridEditFormAction.Close;
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Ошибка при сохранении {item.Name}: {ex.Message}", Severity.Error);
			
			return DataGridEditFormAction.KeepOpen;
		}
	}

	private async Task DeleteItemAsync(Location item)
	{
		if (_isProcessing) return;

		if (await ConfirmDeleteItemAsync(item))
		{
			try
			{
				_isProcessing = true;

				var result = await Service.DeleteAsync(item.Id);

				if (result.IsSuccess)
					Snackbar.Add($"Успешно удалено: {item.Name}", Severity.Success);
				else
					Snackbar.Add($"Ошибка при удалении {item.Name}: {result.Error.Description}", Severity.Error);
			}
			catch (Exception ex)
			{
				Snackbar.Add($"Ошибка при удалении {item.Name}: {ex.Message}", Severity.Error);
			}
			finally
			{
				_isProcessing = false;

				await LoadDataAsync();
			}
		}
	}

	private async Task<bool> ConfirmDeleteItemAsync(Location item)
	{
		var title = "Удалить Локацию";

		var parameters = new DialogParameters<ConfirmDialog>
		{
			{ x => x.TitleIcon, Icons.Material.Filled.Delete },
			{ x => x.ContentText, $"Вы уверены, что хотите удалить '{item.Name}'?" },
			{ x => x.ButtonText, "Да, удалить" },
			{ x => x.ConfirmColor, Color.Secondary }
		};

		var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

		var dialog = await DialogService.ShowAsync<ConfirmDialog>(title, parameters, options);

		var result = await dialog.Result;

		return result is { Canceled: false };
	}


	private async Task RestoreItemAsync(Location item)
	{
		if (_isProcessing) return;

		if (await ConfirmRestoreItemAsync(item))
		{
			try
			{
				_isProcessing = true;

				var result = await Service.RestoreAsync(item.Id);

				if (result.IsSuccess)
					Snackbar.Add($"Успешно восстановлено: {item.Name}", Severity.Success);
				else
					Snackbar.Add($"Ошибка при восстановлении {item.Name}: {result.Error.Description}", Severity.Error);
			}
			catch (Exception ex)
			{
				Snackbar.Add($"Ошибка при восстановлении {item.Name}: {ex.Message}", Severity.Error);
			}
			finally
			{
				_isProcessing = false;

				await LoadDataAsync();
			}
		}
	}

	private async Task<bool> ConfirmRestoreItemAsync(Location item)
	{
		var title = "Восстановить Локацию";

		var parameters = new DialogParameters<ConfirmDialog>
		{
			{ x => x.TitleIcon, Icons.Material.Filled.RestoreFromTrash },
			{ x => x.ContentText, $"Вы уверены, что хотите восстановить '{item.Name}'?" },
			{ x => x.ButtonText, "Да, восстановить" },
			{ x => x.ConfirmColor, Color.Info }
		};

		var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

		var dialog = await DialogService.ShowAsync<ConfirmDialog>(title, parameters, options);

		var result = await dialog.Result;

		return result is { Canceled: false };
	}

	public void Dispose()
	{
		_cts.Cancel();
		_cts.Dispose();
		GC.SuppressFinalize(this);
	}
}
