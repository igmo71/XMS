@page "/employees"
@using System.Globalization
@using Microsoft.AspNetCore.Authorization
@using XMS.Domain.Models
@attribute [Authorize]

<PageTitle>Сотрудники</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
	<MudPaper>
		<MudDataGrid @ref="_employeeGrid" T="Employee" Items="@_employees" Culture="@(new CultureInfo("ru-RU", false))"
					 Loading="@_isLoading"
					 ReadOnly="@(!_isEditingGrid)"
					 CommittedItemChanges="@((item) => CommittedItemChanges(item))"
					 QuickFilter="QuickFilter"
					 EditMode="DataGridEditMode.Form"
					 EditTrigger="@DataGridEditTrigger.OnRowClick"
					 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
					 ColumnResizeMode="ResizeMode.Container"
					 Dense="true"
					 Hover="true"
					 Striped="true"
					 Bordered="true"
					 Filterable="true"
					 Groupable="true"
					 DragDropColumnReordering="true"
					 ApplyDropClassesOnDragStarted="true"
					 DragIndicatorIcon="@Icons.Material.Filled.DragIndicator">
			<ToolBarContent>
				<MudText Typo="Typo.h5">Сотрудники</MudText>
				<MudSpacer />
				<MudSwitch T="bool" ValueChanged="ToggleEditingGrid" Color="Color.Primary">Редактировать</MudSwitch>
				<MudButton Class="ms-5" StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_isEditingGrid)" OnClick="NewItemAsync">
					Добавить
				</MudButton>
				<MudSpacer />
				<MudTextField @bind-Value="_searchString" Placeholder="ФИО, Должность или Отдел" Adornment="Adornment.Start" Immediate="true"
							  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Clearable="true"></MudTextField>
				<MudSpacer />
			</ToolBarContent>
			<Columns>
				<PropertyColumn Property="x => x.Name" Title="ФИО" DragAndDropEnabled="false" StickyLeft="true">
					<CellTemplate>
						<MudText Style="@( context.Item.IsDeleted ? "opacity: 0.6; text-decoration: line-through;" : "")">@context.Item.Name</MudText>
					</CellTemplate>
					<EditTemplate>
						<MudGrid style="min-width: 500px">
							<MudItem xs="12">
								<MudTextField @bind-Value="context.Item.Name"
											  Label="Ввод ФИО"
											  Variant="Variant.Outlined"
											  Required="true"
											  RequiredError="Нужно ввести ФИО"
											  Clearable="true" />
							</MudItem>
						</MudGrid>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.IsDeleted" Title="Удален">
					<CellTemplate>
						<MudChip T="string" Color="@(context.Item.IsDeleted? Color.Secondary: Color.Info)" Size="Size.Small" Variant="Variant.Text">
							@(context.Item.IsDeleted ? "Удален" : "Активен")
						</MudChip>
					</CellTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.JobTitle == null ? string.Empty : x.JobTitle.Name" Title="Должность">
					<EditTemplate>
						<MudSelect @bind-Value="context.Item.JobTitleId"
								   Label="Выбор Должности"
								   Required="true"
								   RequiredError="Нужно выбрать должность"
								   RelativeWidth="DropdownWidth.Ignore"
								   Variant="Variant.Outlined"
								   Clearable="true"
								   Dense="true">
							@foreach (var item in _jobTitles)
							{
								<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
							}

						</MudSelect>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.Department == null ? string.Empty : x.Department.Name" Title="Отдел">
					<EditTemplate>
						<MudSelect @bind-Value="context.Item.DepartmentId"
								   Label="Выбор Отдела"
								   Required="false"
								   RequiredError="Нужно выбрать отдел"
								   RelativeWidth="DropdownWidth.Ignore"
								   Variant="Variant.Outlined"
								   Clearable="true"
								   Dense="true">
							@foreach (var item in _departments)
							{
								<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
							}

						</MudSelect>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.City == null ? string.Empty : x.City.Name" Title="Город">
					<EditTemplate>
						<MudSelect @bind-Value="context.Item.CityId"
								   Label="Выберите Город"
								   Required="false"
								   RequiredError="Нужно выбрать город"
								   Variant="Variant.Outlined"
								   Clearable="true"
								   Dense="true">
							@foreach (var item in _cities)
							{
								<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
							}
						</MudSelect>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.Location == null ? string.Empty : x.Location.Name" Title="Локация" Required="false">
					<EditTemplate>
						<MudSelect @bind-Value="context.Item.LocationId"
								   Label="Выбор Локации"
								   Required="false"
								   RequiredError="Нужно выбрать локацию"
								   Variant="Variant.Outlined"
								   Clearable="true"
								   Dense="true">
							@foreach (var item in _locations)
							{
								<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
							}

						</MudSelect>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.UserUt == null ? string.Empty : x.UserUt.Name" Title="Пользователь УТ" Required="false">
					<EditTemplate>
						<MudAutocomplete @bind-Value="context.Item.UserUtId"
										 T="Guid?"
										 ToStringFunc="GetUserUtName"
										 SearchFunc="SearchUserUtIds"
										 Variant="Variant.Outlined"
										 Label="Поиск Пользователя УТ"
										 Clearable="true"
										 Dense="true"
										 RelativeWidth="DropdownWidth.Ignore">
							<ItemTemplate Context="id">
								<MudText Typo="Typo.body2" Style="white-space:nowrap">
									@GetUserUtName(id)
								</MudText>
							</ItemTemplate>
						</MudAutocomplete>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.EmployeeBuh == null ? string.Empty : x.EmployeeBuh.Name" Title="Сотрудник БП" Required="false">
					<CellTemplate>
						@context.Item.EmployeeBuh?.Name
						@(string.IsNullOrEmpty(context.Item.EmployeeBuh?.Code) ? string.Empty : $"({context.Item.EmployeeBuh?.Code})")
					</CellTemplate>
					<EditTemplate>
						<MudAutocomplete @bind-Value="context.Item.EmployeeBuhId"
										 T="Guid?"
										 ToStringFunc="GetEmployeeBuhLabel"
										 SearchFunc="SearchEmployeeBuhIds"
										 Variant="Variant.Outlined"
										 Label="Поиск Сотрудника БП"
										 Clearable="true"
										 Dense="true"
										 RelativeWidth="DropdownWidth.Ignore">
							<ItemTemplate Context="id">
								<MudText Typo="Typo.body2" Style="white-space:nowrap">
									@GetEmployeeBuhLabel(id)
								</MudText>
							</ItemTemplate>
						</MudAutocomplete>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.EmployeeZup == null ? string.Empty : x.EmployeeZup.Name" Title="Сотрудник ЗУП" Required="false">
					<CellTemplate>
						@context.Item.EmployeeZup?.Name
						@(string.IsNullOrEmpty(context.Item.EmployeeZup?.Code) ? string.Empty : $"({context.Item.EmployeeZup?.Code})")
					</CellTemplate>
					<EditTemplate>
						<MudAutocomplete @bind-Value="context.Item.EmployeeZupId"
										 T="Guid?"
										 ToStringFunc="GetEmployeeZupLabel"
										 SearchFunc="SearchEmployeeZupIds"
										 Variant="Variant.Outlined"
										 Label="Поиск Сотрудника ЗУП"
										 Clearable="true"
										 Dense="true"
										 RelativeWidth="DropdownWidth.Ignore">
							<ItemTemplate Context="id">
								<MudText Typo="Typo.body2" Style="white-space:nowrap">
									@GetEmployeeZupLabel(id)
								</MudText>
							</ItemTemplate>
						</MudAutocomplete>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.UserAd == null ? string.Empty : x.UserAd.Name" Title="AD User" Required="false">
					<CellTemplate>
						@context.Item.UserAd?.Name
					</CellTemplate>
					<EditTemplate>
						<MudAutocomplete @bind-Value="context.Item.UserAdId" FullWidth="true"
										 T="string"
										 ToStringFunc="GetUserAdName"
										 SearchFunc="SearchUserAdIds"
										 Variant="Variant.Outlined"
										 Label="Поиск Пользователя AD"
										 Clearable="true"
										 Dense="true"
										 RelativeWidth="DropdownWidth.Ignore">
							<ItemTemplate Context="id">
								<MudText Typo="Typo.body2" Style="white-space:nowrap">
									@GetUserAdName(id)
								</MudText>
							</ItemTemplate>
						</MudAutocomplete>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.OperationManager == null ? string.Empty : x.OperationManager.Name" Title="Оперативный Руководитель" Required="false">
					<EditTemplate>
						<MudAutocomplete @bind-Value="context.Item.OperationManagerId" FullWidth="true"
										 T="Guid?"
										 ToStringFunc="GetEmployeeName"
										 SearchFunc="SearchEmployeeIds"
										 Variant="Variant.Outlined"
										 Label="Поиск Оперативного Руководителя"
										 Clearable="true"
										 Dense="true"
										 RelativeWidth="DropdownWidth.Ignore">
							<ItemTemplate Context="id">
								<MudText Typo="Typo.body2" Style="white-space:nowrap">
									@GetEmployeeName(id)
								</MudText>
							</ItemTemplate>
						</MudAutocomplete>
					</EditTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.LocationManager == null ? string.Empty : x.LocationManager.Name" Title="Руководитель Локации" Required="false">
					<EditTemplate>
						<MudAutocomplete @bind-Value="context.Item.LocationManagerId" FullWidth="true"
										 T="Guid?"
										 ToStringFunc="GetEmployeeName"
										 SearchFunc="SearchEmployeeIds"
										 Variant="Variant.Outlined"
										 Label="Поиск Руководителя Локации"
										 Clearable="true"
										 Dense="true"
										 RelativeWidth="DropdownWidth.Ignore">
							<ItemTemplate Context="id">
								<MudText Typo="Typo.body2" Style="white-space:nowrap">
									@GetEmployeeName(id)
								</MudText>
							</ItemTemplate>
						</MudAutocomplete>
					</EditTemplate>
				</PropertyColumn>
				<TemplateColumn Hidden="@(!_isEditingGrid)">
					<CellTemplate>
						@if (context.Item.IsDeleted)
						{
							<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Filled.RestoreFromTrash" Color="Color.Info"
										   OnClick="@(() => RestoreItemAsync(context.Item))" title="Восстановить" />
						}
						else
						{
							<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Secondary"
										   OnClick="@(() => DeleteItemAsync(context.Item))" title="Удалить" />
						}
					</CellTemplate>
					<EditTemplate>
						@if (context.Item.IsDeleted)
						{
							<MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Medium" Color="Color.Info"
									   OnClick="@(() => RestoreItemAsync(context.Item))" Class="mt-3">
								Восстановить
							</MudButton>
						}
						else
						{
							<MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Medium" Color="Color.Secondary"
									   OnClick="@(() => DeleteItemAsync(context.Item))" Class="mt-3">
								Удалить
							</MudButton>
						}
						
					</EditTemplate>
				</TemplateColumn>
			</Columns>
			<LoadingContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Left">
					Загрузка из БД...
				</MudAlert>
			</LoadingContent>
			<NoRecordsContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Здесь пока ничего нет. Нажмите "Добавить", чтобы создать первый!
				</MudAlert>
			</NoRecordsContent>
			<PagerContent>
				<MudDataGridPager T="Employee" />
			</PagerContent>
		</MudDataGrid>
	</MudPaper>
</MudContainer>

