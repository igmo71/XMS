@page "/departments"
@using Microsoft.AspNetCore.Authorization
@using XMS.Domain.Models
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Medium">
	<MudPaper>
		<MudToolBar>
			<MudStack Row="true" Spacing="6">
				<MudText Typo="Typo.h5">Схема предприятия</MudText>
				<MudFab Color="Color.Primary" Size="Size.Small"
						StartIcon="@(_expandedAll ? Icons.Material.Filled.VerticalAlignCenter : Icons.Material.Filled.Expand)"
						OnClick="@(_expandedAll ? CollapseAll : ExpandAll)" title="Свернуть все" />
				<MudSwitch T="bool" ValueChanged="ToggleIncludeDelete" Color="Color.Primary">Показать удаленные</MudSwitch>
			</MudStack>
		</MudToolBar>
		<MudTreeView Items="_treeItems" T="Department" Dense="true">
			<ItemTemplate Context="item">
				<MudTreeViewItem Expanded="@item.Expanded"
								 ExpandedChanged="@((expanded) => ExpandedChanged(item, expanded))"
								 Items="@item.Children"
								 Value="@item.Value">
					<Content>
						<MudTreeViewItemToggleButton Expanded="@item.Expanded"
													 ExpandedChanged="@((expanded) => ExpandedChanged(item, expanded))"
													 Visible="@item.HasChildren" />
						<MudIcon Icon="@GetIcon(item)" Size="@(item.HasChildren? Size.Medium : Size.Small)"
								 Class="@(item.Value?.IsDeleted == true ? "mr-2 text-secondary" : "mr-2")" />
						<MudText Typo="@(item.HasChildren? Typo.body1: Typo.body2)"
								 Class="@(item.Value?.IsDeleted == true ? "text-secondary text-decoration-line-through" : "")">
							@item.Value?.Name
						</MudText>
						<MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Medium" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft" Dense="true">
							@if (item.Value?.IsDeleted == true)
							{
								<MudMenuItem Label="Восстановить" Icon="@Icons.Material.Filled.RestoreFromTrash" IconColor="Color.Info" OnClick="() => RestoreDepartmentAsync(item.Value)" />
							}
							else
							{
								<MudMenuItem Label="Добавить " Icon="@Icons.Material.Filled.CreateNewFolder" IconColor="Color.Primary" OnClick="() => NewDepartmentAsync(item.Value)" />
								@if (item.Value is Department department && department.ParentId is not null)
								{
									<MudMenuItem Label="Изменить" Icon="@Icons.Material.Filled.Edit" IconColor="Color.Primary" OnClick="() => EditDepartmentAsync(item.Value)" />
									<MudMenuItem Label="Удалить" Icon="@Icons.Material.Filled.Delete" IconColor="Color.Secondary" OnClick="() => DeleteDepartmentAsync(item.Value)" />
								}
							}
						</MudMenu>
					</Content>
				</MudTreeViewItem>
			</ItemTemplate>
		</MudTreeView>
	</MudPaper>
</MudContainer>