@using XMS.Domain.Models
@using XMS.Web.Components.Common
<MudDialog>
	<TitleContent>
		<MudStack Row="true">
			<MudIcon Icon="@TitleIcon" />
			<MudText Typo="Typo.h5">@MudDialog.Title</MudText>
		</MudStack>
	</TitleContent>
	<DialogContent>
		<MudForm @ref="_form">
			<MudTextField @bind-Value="CostCategory.Name" T="string"
						  Label="Ввод Наименования"
						  Required="true"
						  RequiredError="Нужно ввести Наименование"
						  Variant="Variant.Outlined" />
			<MudSelect @bind-Value="CostCategory.ParentId"
					   Label="Выбор Родительской Категории"
					   Required="false"
					   RequiredError="Нужно выбрать Категорию"
					   RelativeWidth="DropdownWidth.Ignore"
					   Variant="Variant.Outlined"
					   Clearable="true"
					   Dense="true">
				@foreach (var item in _categoriesFlattenedTree)
				{
					<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
				}
			</MudSelect>
			<MudSelect @bind-SelectedValues="_selectedItems" T="CostItem"
					   Label="Выбор Статьи затрат"
					   MultiSelection="true"
					   AnchorOrigin="Origin.TopCenter"
					   TransformOrigin="Origin.BottomCenter"
					   ToStringFunc="@(e => e == null ? string.Empty : e.Name)"
					   Variant="Variant.Outlined"
					   Clearable="true"
					   Dense="true">
				@foreach (var item in CostItems)
				{
					<MudSelectItem Value="@item">@item.Name</MudSelectItem>
				}
			</MudSelect>
			<MudSelect @bind-Value="CostCategory.DepartmentId"
					   Label="Выбор Отдела"
					   Required="false"
					   RequiredError="Нужно выбрать отдел"
					   RelativeWidth="DropdownWidth.Ignore"
					   Variant="Variant.Outlined"
					   Clearable="true"
					   Dense="true">
				@foreach (var item in _departmentsFlattenedTree)
				{
					<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
				}
			</MudSelect>
			<MudAutocomplete @bind-Value="CostCategory.EmployeeId"
							 T="Guid?"
							 ToStringFunc="GetEmployeeName"
							 SearchFunc="SearcEmployeeIds"
							 Variant="Variant.Outlined"
							 Label="Подбор Сотрудника"
							 Clearable="true"
							 Dense="true"
							 RelativeWidth="DropdownWidth.Ignore">
				<ItemTemplate Context="id">
					<MudText Typo="Typo.body2" Style="white-space:nowrap">
						@GetEmployeeName(id)
					</MudText>
				</ItemTemplate>
			</MudAutocomplete>
		</MudForm>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Cancel">Отменить</MudButton>
		<MudButton OnClick="Submit" Color="Color.Primary">Сохранить</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
	[Parameter] public string? TitleIcon { get; set; }
	[Parameter] public CostCategory CostCategory { get; set; } = new();
	[Parameter] public IEnumerable<CostCategory> CostCategories { get; set; } = [];
	[Parameter] public IEnumerable<CostItem> CostItems { get; set; } = [];
	[Parameter] public IEnumerable<Department> Departments { get; set; } = [];
	[Parameter] public IEnumerable<Employee> Employees { get; set; } = [];

	private MudForm _form = default!;

	private IEnumerable<CostCategory> _categoriesFlattenedTree = [];
	private IEnumerable<Department> _departmentsFlattenedTree = [];
	private IReadOnlyCollection<CostItem> _selectedItems = [];

	protected override void OnInitialized()
	{
		var forbiddenCaregoryIds = TreeHelper.GetForbiddenParentIds(CostCategory, CostCategories);
		var availableCoategories = CostCategories.Where(e => !forbiddenCaregoryIds.Contains(e.Id)).ToList();
		_categoriesFlattenedTree = TreeHelper.BuildFlattenedTree(availableCoategories);

		_departmentsFlattenedTree = TreeHelper.BuildFlattenedTree(Departments);

		if (CostCategory.Items != null)
		{
			var selectedIds = CostCategory.Items.Select(x => x.Id).ToHashSet();

			_selectedItems = CostItems
				.Where(x => selectedIds.Contains(x.Id))
				.ToList();
		}
	}

	private void Cancel() => MudDialog.Cancel();

	private async Task Submit()
	{
		await _form.Validate();
		if (_form.IsValid)
		{
			CostCategory.Items = _selectedItems.ToList();

			MudDialog.Close(DialogResult.Ok(CostCategory));
		}
	}

	private Task<IEnumerable<Guid?>> SearcEmployeeIds(string value, CancellationToken token)
	{
		if (Employees is null)
			return Task.FromResult(Enumerable.Empty<Guid?>());

		if (string.IsNullOrEmpty(value))
			return Task.FromResult(Employees.Select(e => e.Id as Guid?));

		return Task.FromResult(Employees
			.Where(x => x.Name != null && x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase))
			.Select(e => e.Id as Guid?));
	}

	private string? GetEmployeeName(Guid? id) => Employees.FirstOrDefault(x => x.Id == id)?.Name;
}
