@page "/jobTitles"
@using Microsoft.AspNetCore.Authorization
@using XMS.Application.Abstractions.Services
@using XMS.Domain.Models
@using XMS.Web.Components.Common
@implements IDisposable
@inject IJobTitleService Service
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Medium">
	<MudPaper>
		<MudDataGrid @ref="_itemGrid"
					 T="JobTitle"
					 Items="@_items"
					 Loading="@_isLoading"
					 EditMode="DataGridEditMode.Form"
					 EditTrigger="DataGridEditTrigger.Manual"
					 CommittedItemChanges="@((item) => CommittedItemChanges(item))"
					 ReadOnly="false"
					 Filterable="true"
					 Bordered="true"
					 Striped="true"
					 Hover="true"
					 Dense="true">
			<ToolBarContent>
				<MudText Typo="Typo.h5">Должности</MudText>
				<MudSpacer />
				<MudButtonGroup Class="ma-0 pa-0" Color="Color.Primary" Variant="Variant.Filled">
					<MudButton OnClick="NewItemAsync" StartIcon="@Icons.Material.Filled.Add">
						Добавить
					</MudButton>
				</MudButtonGroup>
			</ToolBarContent>
			<Columns>
				<MudBlazor.PropertyColumn Property="x => x.Name" Title="Наименование" />
				<TemplateColumn CellClass="d-flex justify-between">
					<CellTemplate>
						<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Color="Color.Primary" OnClick="@context.Actions.StartEditingItemAsync" />
						<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Secondary" OnClick="@(() => DeleteItemAsync(context.Item))" />
					</CellTemplate>
				</TemplateColumn>
			</Columns>
			<LoadingContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Загрузка из БД...
				</MudAlert>
			</LoadingContent>
			<NoRecordsContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Здесь пока ничего нет. Нажмите "Добавить", чтобы создать первый!
				</MudAlert>
			</NoRecordsContent>
			<PagerContent>
				<MudDataGridPager T="JobTitle" />
			</PagerContent>
		</MudDataGrid>
	</MudPaper>
</MudContainer>

@code {
	private readonly CancellationTokenSource _cts = new();
	private IReadOnlyList<JobTitle> _items = [];
	private MudDataGrid<JobTitle> _itemGrid = default!;
	private bool _isLoading;
	private bool _isProcessing;

	protected async override Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		if (_isLoading) return;

		_isLoading = true;
		try
		{
			_items = await Service.GetListAsync(_cts.Token);
		}
		finally
		{
			_isLoading = false;

			StateHasChanged();
		}
	}

	private async Task NewItemAsync()
	{
		var item = new JobTitle();

		await _itemGrid.SetEditingItemAsync(item);
	}

	private async Task<DataGridEditFormAction> CommittedItemChanges(JobTitle item)
	{
		try
		{
			if (!_items.Any(x => x.Id == item.Id))
				await Service.CreateAsync(item);
			else
				await Service.UpdateAsync(item);

			Snackbar.Add($"Успешно сохранено: {item.Name}", Severity.Success);

			await LoadDataAsync();
			
			return DataGridEditFormAction.Close;
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Ошибка при сохранении {item.Name}: {ex.Message}", Severity.Error);
						
			return DataGridEditFormAction.KeepOpen;
		}
	}

	private async Task DeleteItemAsync(JobTitle item)
	{
		if (_isProcessing) return;

		if (await ConfirmDeleteItemAsync(item))
		{
			try
			{
				_isProcessing = true;

				var result = await Service.DeleteAsync(item.Id);

				if (result.IsSuccess)
					Snackbar.Add($"Успешно удалено: {item.Name}", Severity.Success);
				else
					Snackbar.Add($"Ошибка при удалении {item.Name}: {result.Error.Description}", Severity.Error);
			}
			catch (Exception ex)
			{
				Snackbar.Add($"Ошибка при удалении {item.Name}: {ex.Message}", Severity.Error);
			}
			finally
			{
				_isProcessing = false;

				await LoadDataAsync();
			}
		}
	}

	private async Task<bool> ConfirmDeleteItemAsync(JobTitle item)
	{
		var title = "Удалить Должность";

		var parameters = new DialogParameters<ConfirmDialog>
		{
			{ x => x.TitleIcon, Icons.Material.Filled.DeleteForever },
			{ x => x.ContentText, $"Вы уверены, что хотите удалить '{item.Name}' навсегда?" },
			{ x => x.ButtonText, "Да, удалить" },
			{ x => x.ConfirmColor, Color.Error }
		};

		var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

		var dialog = await DialogService.ShowAsync<ConfirmDialog>(title, parameters, options);

		var result = await dialog.Result;

		return result is { Canceled: false };
	}

	public void Dispose()
	{
		_cts.Cancel();
		_cts.Dispose();
		GC.SuppressFinalize(this);
	}
}
