@page "/emploees-buh"
@using Microsoft.AspNetCore.Authorization
@using XMS.Application.Abstractions.Services
@using XMS.Domain.Models
@implements IDisposable
@inject IEmployeeBuhService Service
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Large">
	<MudPaper>
		<MudDataGrid Items="@_items"
					 Loading="@_isLoading"
					 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
					 Filterable="true"
					 Dense="true">
			<ToolBarContent>
				<MudText Typo="Typo.h5">Сотрудники 1С Бух</MudText>
				<MudSpacer />
				<MudSpacer />
				<MudButton OnClick="ReloadDataFromOneSAsync" Color="Color.Primary" Variant="Variant.Filled">
					@if (_isReloading)
					{
						<MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
						<MudText Class="ms-2">Синхронизация...</MudText>
					}
					else
					{
						<MudIcon Icon="@Icons.Material.Filled.Sync" Class="me-2" />
						<MudText>Обновить из 1С</MudText>
					}
				</MudButton>
				<MudSpacer />
			</ToolBarContent>
			<Columns>
				<PropertyColumn Property="x => x.Id" />
				<PropertyColumn Property="x => x.Name" Title="ФИО" />
				<PropertyColumn Property="x => x.Code" Title="Code" />
				<PropertyColumn Property="x => x.IsDeleted" Title="Пометка удаления">
					<CellTemplate>
						<MudChip T="string"
								 Color="@(context.Item.IsDeleted ? Color.Secondary: Color.Info)"
								 Size="Size.Small"
								 Variant="Variant.Text">
							@(context.Item.IsDeleted ? "Удален" : "Активен")
						</MudChip>
					</CellTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.Archived" Title="В архиве">
					<CellTemplate>
						<MudChip T="string"
								 Color="@(context.Item.Archived ? Color.Secondary: Color.Info)"
								 Size="Size.Small"
								 Variant="Variant.Text">
							@(context.Item.Archived ? "В архиве" : "Активен")
						</MudChip>
					</CellTemplate>
				</PropertyColumn>
			</Columns>
			<LoadingContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Загрузка из БД...
				</MudAlert>
			</LoadingContent>
			<NoRecordsContent>
				<MudAlert Severity="Severity.Warning" ContentAlignment="HorizontalAlignment.Center" Class="mx-3">
					Пользователи не найдены. Нажмите "Обновить", чтобы загрузить данные.
				</MudAlert>
			</NoRecordsContent>
			<PagerContent>
				<MudDataGridPager T="EmployeeBuh" />
			</PagerContent>
		</MudDataGrid>
	</MudPaper>
</MudContainer>

@code {	
	private readonly CancellationTokenSource _cts = new();
	private IEnumerable<EmployeeBuh> _items = [];
	private bool _isLoading;
	private bool _isReloading;
	private bool _includeDeleted = true;

	protected override async Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		if (_isLoading) return;

		_isLoading = true;
		try
		{
			_items = await Service.GetListAsync(_includeDeleted, _cts.Token);
		}
		finally
		{
			_isLoading = false;

			StateHasChanged();
		}
	}

	private async Task ReloadDataFromOneSAsync()
	{
		_isReloading = true;
		try
		{
			Snackbar.Add("Синхронизация с 1С...", Severity.Info);

			await Service.ReloadListAsync(_cts.Token);

			Snackbar.Add("Данные успешно синхронизированы с 1С", Severity.Success);

			await LoadDataAsync();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Ошибка при обмене с 1С: {ex.Message}", Severity.Error);
		}
		finally
		{
			_isReloading = false;
		}
	}	

	public void Dispose()
	{
		_cts.Cancel();
		_cts.Dispose();
		GC.SuppressFinalize(this);
	}
}
