@page "/admin/users"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using XMS.Components.Common
@using XMS.Data
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Admin")]


<MudContainer MaxWidth="MaxWidth.Large">
	<MudDataGrid T="ApplicationUser"
				 Items="_users"
				 ReadOnly="false"
				 EditMode="DataGridEditMode.Form"
				 EditTrigger="DataGridEditTrigger.Manual"
				 CommittedItemChanges="@CommittedItemChanges"
				 Bordered="true" Dense="true">
		<ToolBarContent>
			<MudText Typo="Typo.h5">Пользователи</MudText>
		</ToolBarContent>
		<Columns>
			<PropertyColumn Property="x => x.UserName" Editable="false" />
			<TemplateColumn Title="Roles">
				<CellTemplate>
					@if (_userRoles.ContainsKey(context.Item.Id))
						foreach (var role in _userRoles[context.Item.Id].Order())
						{
							<MudChip T="string" Variant="Variant.Text">
								@role
							</MudChip>
						}
				</CellTemplate>
				<EditTemplate>
					<MudSelect @bind-SelectedValues="_userRoles[context.Item.Id]" T="string"
							   Label="Выбор роли"
							   MultiSelection="true"
							   AnchorOrigin="Origin.TopCenter"
							   TransformOrigin="Origin.BottomCenter"
							   Variant="Variant.Outlined"
							   Clearable="true"
							   Dense="true">
						@foreach (var role in _roles)
						{
							<MudSelectItem Value="@role.Name">@role.Name</MudSelectItem>
						}
					</MudSelect>
				</EditTemplate>
			</TemplateColumn>
			<TemplateColumn Title="Битрикс">
				<CellTemplate>
					<MudStack Row=true Spacing="2">
						<MudText>@context.Item.LastName</MudText>
						<MudText>@context.Item.FirstName</MudText>
						<MudText>@context.Item.MiddleName</MudText>
					</MudStack>
				</CellTemplate>
			</TemplateColumn>
			<TemplateColumn CellClass="d-flex justify-between">
				<CellTemplate>
					<MudIconButton Size="@Size.Medium" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
					<MudIconButton Size="@Size.Medium" Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItem(context.Item))" />
				</CellTemplate>
			</TemplateColumn>
		</Columns>
	</MudDataGrid>
</MudContainer>

@code {
	private List<ApplicationUser> _users = [];
	private List<IdentityRole> _roles = [];
	private Dictionary<string, IEnumerable<string>> _userRoles = [];

	protected override async Task OnInitializedAsync()
	{
		await LoadData();
	}

	private async Task LoadData()
	{
		_users = UserManager.Users.OrderBy(e => e.UserName).ToList();
		_roles = RoleManager.Roles.OrderBy(e => e.Name).ToList();

		_userRoles = [];

		foreach (var user in _users)
		{
			_userRoles.Add(user.Id, await UserManager.GetRolesAsync(user));
		}
	}

	private async Task CommittedItemChanges(ApplicationUser user)
	{
		var existingRoles = await UserManager.GetRolesAsync(user);

		var rolesToAdd = _userRoles[user.Id].Where(e => !existingRoles.Contains(e));

		var result = await UserManager.AddToRolesAsync(user, rolesToAdd);

		if (!result.Succeeded)
			Snackbar.Add($"Добавить '{user.UserName}' в роли не удалось: {string.Join(", ", result.Errors.Select(error => error.Description))}", Severity.Error);

		var rolesToRemove = existingRoles.Where(e => !_userRoles[user.Id].Contains(e));

		result = await UserManager.RemoveFromRolesAsync(user, rolesToRemove);
				
		if (!result.Succeeded)
			Snackbar.Add($"Удалить '{user.UserName}' из ролей не удалось: {string.Join(", ", result.Errors.Select(error => error.Description))}", Severity.Error);

		await LoadData();
	}

	private async Task DeleteItem(ApplicationUser user)
	{
		if (await ConfirmDeleteItemAsync(user))
		{
			var result = await UserManager.DeleteAsync(user);

			if (result.Succeeded)
				Snackbar.Add($"Пользователь '{user.UserName}' удален", Severity.Success);
			else
				Snackbar.Add($"Удаление '{user.UserName}' не удалось: {string.Join(", ", result.Errors.Select(error => error.Description))}", Severity.Error);
		}

		await LoadData();
		
	}

	private async Task<bool> ConfirmDeleteItemAsync(ApplicationUser user)
	{
		var title = "Удалить Пользователя";

		var parameters = new DialogParameters<ConfirmDialog>
		{
			{ x => x.TitleIcon, Icons.Material.Filled.DeleteForever },
			{ x => x.ContentText, $"Вы уверены, что хотите удалить пользователя '{user.UserName}' навсегда?" },
			{ x => x.ButtonText, "Да, Удалить" },
			{ x => x.ConfirmColor, Color.Error }
		};

		var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

		var dialog = await DialogService.ShowAsync<ConfirmDialog>(title, parameters, options);

		var result = await dialog.Result;

		return result is { Canceled: false };
	}
}
