@page "/locations"
@using XMS.Components.Common
@using XMS.Modules.Employees.Abstractions
@using XMS.Modules.Employees.Domain
@implements IDisposable
@inject ILocationService Service
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium">
	<MudPaper>
		<MudDataGrid @ref="_itemGrid"
					 T="Location"
					 Items="@_items"
					 Loading="@_isLoading"
					 EditMode="DataGridEditMode.Form"
					 EditTrigger="DataGridEditTrigger.Manual"
					 CommittedItemChanges="@CommittedItemChanges"
					 ReadOnly="false"
					 Bordered="true"
					 Dense="true"
					 Hover="true"
					 Striped="true"
					 Filterable="true">
			<ToolBarContent>
				<MudText Typo="Typo.h4">Локации</MudText>
				<MudSpacer />
				<MudButtonGroup Class="ma-0 pa-0" Color="Color.Primary" Variant="Variant.Filled">
					<MudButton OnClick="NewItemAsync" StartIcon="@Icons.Material.Filled.Add">
						Добавить
					</MudButton>
				</MudButtonGroup>
			</ToolBarContent>
			<Columns>
				<MudBlazor.PropertyColumn Property="x => x.Name" Title="Наименование" />
				<TemplateColumn CellClass="d-flex justify-between">
					<CellTemplate>
						<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Color="Color.Primary" OnClick="@context.Actions.StartEditingItemAsync" />
						<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Secondary" OnClick="@(() => DeleteItemAsync(context.Item))" />
					</CellTemplate>
				</TemplateColumn>
			</Columns>
			<LoadingContent>
				<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
					Загрузка из БД...
				</MudAlert>
			</LoadingContent>
			<NoRecordsContent>
				<MudText Typo="Typo.h6" Align="Align.Center" Class="pa-4">
					Здесь пока ничего нет. Нажмите "Добавить", чтобы создать первый!
				</MudText>
			</NoRecordsContent>
			<PagerContent>
				<MudDataGridPager T="Location" />
			</PagerContent>
		</MudDataGrid>
	</MudPaper>
</MudContainer>

@code {
	private readonly CancellationTokenSource _cts = new();
	private IReadOnlyList<Location> _items = [];
	private MudDataGrid<Location> _itemGrid = default!;
	private bool _isLoading;
	private bool _isProcessing;

	protected async override Task OnInitializedAsync()
	{
		await LoadDataAsync();
	}

	private async Task LoadDataAsync()
	{
		_isLoading = true;
		try
		{
			_items = await Service.GetListAsync(_cts.Token);
		}
		finally
		{
			_isLoading = false;
		}
	}

	private async Task NewItemAsync()
	{
		var item = new Location();

		await _itemGrid.SetEditingItemAsync(item);
	}

	private async Task CommittedItemChanges(Location item)
	{
		try
		{
			if (!_items.Any(x => x.Id == item.Id))
				await Service.CreateAsync(item);
			else
				await Service.UpdateAsync(item);

			Snackbar.Add($"Успешно сохранено: {item.Name}", Severity.Success);

			await LoadDataAsync();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Ошибка при сохранении {item.Name}: {ex.Message}", Severity.Error);
		}
	}

	private async Task DeleteItemAsync(Location item)
	{
		if (_isProcessing) return;

		if (await ConfirmDeleteItemAsync(item))
		{
			try
			{
				_isProcessing = true;

				await Service.DeleteAsync(item.Id);

				await LoadDataAsync();

				Snackbar.Add($"Успешно удалено: {item.Name}", Severity.Success);
			}
			catch (Exception ex)
			{
				Snackbar.Add($"Ошибка при удалении {item.Name}: {ex.Message}", Severity.Error);
			}
			finally
			{
				_isProcessing = false;
			}
		}
	}

	private async Task<bool> ConfirmDeleteItemAsync(Location item)
	{
		var parameters = new DialogParameters<ConfirmDialog>
		{
			{ x => x.ContentText, $"Вы уверены, что хотите удалить '{item.Name}' навсегда?" },
			{ x => x.ButtonText, "Да, удалить" },
			{ x => x.ButtonColor, Color.Error }
		};

		var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

		var dialog = await DialogService.ShowAsync<ConfirmDialog>("Удаление", parameters, options);

		var result = await dialog.Result;

		return result is { Canceled: false };
	}

	public void Dispose()
	{
		_cts.Cancel();
		_cts.Dispose();
	}
}
