@using XMS.Components.Common
@using XMS.Modules.Costs.Domain
<MudDialog>
	<TitleContent>
		<MudText Typo="Typo.h6">
			<MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3 mb-n1" />
			@MudDialog.Title
		</MudText>
	</TitleContent>
	<DialogContent>
		<MudForm @ref="_form">
			<MudSelect @bind-Value="Category.ParentId"
					   Label="Родительской Категории"
					   Required="false"
					   RequiredError="Нужно выбрать Категорию"
					   RelativeWidth="DropdownWidth.Ignore"
					   Variant="Variant.Outlined"
					   Clearable="true"
					   Dense="true">
				@foreach (var item in _categoriesFlattenedTree)
				{
					<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
				}
			</MudSelect>
			<MudTextField @bind-Value="Category.Name" T="string"
						  Label="Наименование"
						  Required="true"
						  RequiredError="Нужно ввести Наименование" />
			<MudSelect T="CostItem"
					   Label="Статьи затрат"
					   MultiSelection="true"
					   AnchorOrigin="Origin.TopCenter"
					   TransformOrigin="Origin.BottomCenter"
					   ToStringFunc="@(e => e == null ? string.Empty : e.Name)"
					   @bind-SelectedValues="_selectedItems">
				@foreach (var item in ItemList)
				{
					<MudSelectItem Value="@item">@item.Name</MudSelectItem>
				}
			</MudSelect>
		</MudForm>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Cancel">Отмена</MudButton>
		<MudButton OnClick="Submit" Color="Color.Primary">Сохранить</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
	[Parameter] public CostCategory Category { get; set; } = new();
	[Parameter] public IEnumerable<CostCategory> CategoryList { get; set; } = [];
	[Parameter] public IEnumerable<CostItem> ItemList { get; set; } = [];
	private MudForm _form = default!;
	private IEnumerable<CostCategory> _categoriesFlattenedTree = [];
	private IEnumerable<CostItem> _selectedItems = [];

	protected override void OnInitialized()
	{
		var forbiddenCaregoryIds = TreeHelper.GetForbiddenParentIds(Category, CategoryList);

		var availableCoategories = CategoryList
			.Where(e => !forbiddenCaregoryIds.Contains(e.Id))
			// .OrderBy(Edge => Edge.Name)
			.ToList();

		_categoriesFlattenedTree = TreeHelper.BuildFlattenedTree(availableCoategories);


		if (Category.Items != null)
		{
			var selectedIds = Category.Items.Select(x => x.Id).ToHashSet();

			_selectedItems = ItemList
				.Where(x => selectedIds.Contains(x.Id))
				.ToList();
		}
	}

	private void Cancel() => MudDialog.Cancel();

	private async Task Submit()
	{
		await _form.Validate();
		if (_form.IsValid)
		{
			Category.Items = _selectedItems.ToList();

			MudDialog.Close(DialogResult.Ok(Category));
		}
	}
}
