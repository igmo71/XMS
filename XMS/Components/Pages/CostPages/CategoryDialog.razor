@using XMS.Modules.Costs.Domain
<MudDialog>
	<TitleContent>
		<MudText Typo="Typo.h6">
			<MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3 mb-n1" />
			@MudDialog.Title
		</MudText>
	</TitleContent>
	<DialogContent>
		<MudForm @ref="_form">
			<MudSelect @bind-Value="Model.ParentId"
					   Label="Родительской Категории"
					   Required="false"
					   RequiredError="Нужно выбрать Категорию"
					   RelativeWidth="DropdownWidth.Ignore"
					   Variant="Variant.Outlined"
					   Clearable="true"
					   Dense="true">
				@foreach (var item in CategoriesFlattenedTree)
				{
					<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
				}

			</MudSelect>
			<MudTextField @bind-Value="Model.Name" T="string"
						  Label="Наименование"
						  Required="true"
						  RequiredError="Нужно ввести Наименование" />
			<MudSelect T="CostItem"
					   Label="Статьи затрат"
					   MultiSelection="true"
					   AnchorOrigin="Origin.TopCenter"
					   TransformOrigin="Origin.BottomCenter"
					   ToStringFunc="@(e => e == null ? string.Empty : e.Name)"
					   @bind-SelectedValues="_selectedItems">
				@foreach (var item in AllItems)
				{
					<MudSelectItem Value="@item">@item.Name</MudSelectItem>
				}
			</MudSelect>
		</MudForm>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Cancel">Отмена</MudButton>
		<MudButton OnClick="Submit" Color="Color.Primary">Сохранить</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
	[Parameter] public CostCategory Model { get; set; } = new();
	[Parameter] public IEnumerable<CostCategory> CategoriesFlattenedTree { get; set; } = [];
	[Parameter] public IEnumerable<CostItem> AllItems { get; set; } = [];
	private MudForm _form = default!;
	private IEnumerable<CostItem> _selectedItems = new HashSet<CostItem>();

	protected override void OnInitialized()
	{
		if (Model.Items != null)
		{
			var selectedIds = Model.Items.Select(x => x.Id).ToHashSet();

			_selectedItems = AllItems
				.Where(x => selectedIds.Contains(x.Id))
				.ToList();
		}
	}

	private void Cancel() => MudDialog.Cancel();

	private async Task Submit()
	{
		await _form.Validate();
		if (_form.IsValid)
		{
			Model.Items = _selectedItems.ToList();

			MudDialog.Close(DialogResult.Ok(Model));
		}
	}
}
