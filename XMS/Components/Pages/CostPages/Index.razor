@page "/costitems"

@using XMS.Components.Common
@using XMS.Modules.Costs.Abstractions
@using XMS.Modules.Costs.Domain
@inject ICostService CostService

<MudContainer MaxWidth="MaxWidth.Large">
	<MudStack>
		<MudPaper Class="pa-4" Width="600px">
			<MudStack Row="true">
				<MudText Typo="Typo.h4">Схема предприятия</MudText>
				<MudSpacer />
				@if (_expandedAll)
				{
					<MudFab Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.VerticalAlignCenter" OnClick="CollapseAll" title="Свернуть все" />
				}
				else
				{
					<MudFab Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Expand" OnClick="ExpandAll" title="Развернуть все" />
				}
			</MudStack>
		</MudPaper>

		<MudPaper Width="600px" Elevation="0" Outlined="true">
			<MudTreeView Items="_treeItems" T="CostCategory">
				<ItemTemplate Context="item">
					<MudTreeViewItem @bind-Expanded="@item.Expanded"
									 Items="@item.Children"
									 Value="@item.Value"
									 Text="@item.Value?.Name"
									 Icon="@GetIcon(item)" />
				</ItemTemplate>
			</MudTreeView>
		</MudPaper>
	</MudStack>
</MudContainer>

@code {
	private readonly CancellationTokenSource _cts = new();
	private List<TreeItemData<CostCategory>> _treeItems = new();
	private bool _expandedAll;

    protected override async Task OnInitializedAsync()
    {
        var categories = await CostService.GetCategoryTreeAsync();

        _treeItems = TreeHelper.BuildTree(categories, null);
    }

	private void ExpandAll()
	{
		_treeItems.SetExpansion(true);
		_expandedAll = true;
	}
	private void CollapseAll()
	{
		_treeItems.SetExpansion(false);
		_expandedAll = false;
	}

	private string GetIcon(ITreeItemData<CostCategory> item)
	{
		if (item.HasChildren)
			return item.Expanded ? Icons.Material.Filled.FolderOpen : Icons.Material.Filled.Folder;

		return Icons.Material.Filled.Category;
	}
    
    
}
