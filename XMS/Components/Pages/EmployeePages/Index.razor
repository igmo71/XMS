@page "/employees"
@using System.Globalization
@using XMS.Modules.Employees.Domain

<PageTitle>Сотрудники</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
	<MudDataGrid @ref="_employeeGrid" T="Employee" Items="@_employees" Culture="@(new CultureInfo("ru-RU", false))"
				 Loading="@_isLoading"
				 Bordered="true" Dense="true" Striped="true" Hover="true"
				 Filterable="true" FilterMode="DataGridFilterMode.Simple" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
				 SortMode="SortMode.Single"
				 ReadOnly="@(!_isEditingGrid)"
				 Groupable="true"
				 ColumnResizeMode="ResizeMode.Container"
				 EditMode="DataGridEditMode.Form" EditTrigger="@DataGridEditTrigger.OnRowClick"
				 CommittedItemChanges="@CommittedItemChanges"
				 QuickFilter="QuickFilter"
				 DragDropColumnReordering="true"
				 ApplyDropClassesOnDragStarted="true"
				 DragIndicatorIcon="@Icons.Material.Filled.DragIndicator">
		<ToolBarContent>
			<MudText Typo="Typo.h4">Сотрудники</MudText>
			<MudSpacer />
			<MudSwitch T="bool" ValueChanged="ToggleEditingGrid" Color="Color.Primary">Редактировать</MudSwitch>
			<MudButton Class="ms-5" StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_isEditingGrid)" OnClick="NewItemAsync">
				Добавить
			</MudButton>
			<MudSpacer />
			<MudTextField @bind-Value="_searchString" Placeholder="ФИО, Должность или Отдел" Adornment="Adornment.Start" Immediate="true"
						  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Clearable="true"></MudTextField>
			<MudSpacer />
		</ToolBarContent>
		<Columns>
			<PropertyColumn Property="x => x.Name" Title="ФИО" DragAndDropEnabled="false" StickyLeft="true">
				<EditTemplate>
					<MudGrid style="min-width: 500px">
						<MudItem xs="12">
							<MudTextField @bind-Value="context.Item.Name"
										  Label="Ввод ФИО"
										  Variant="Variant.Outlined"
										  Required="true"
										  RequiredError="Нужно ввести ФИО"
										  Clearable="true" />
						</MudItem>
					</MudGrid>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.JobTitle == null ? string.Empty : x.JobTitle.Name" Title="Должность">
				<EditTemplate>
					<MudSelect @bind-Value="context.Item.JobTitleId"
							   Label="Выбор Должности"
							   Required="true"
							   RequiredError="Нужно выбрать должность"
							   RelativeWidth="DropdownWidth.Ignore"
							   Variant="Variant.Outlined"
							   Clearable="true"
							   Dense="true">
						@foreach (var item in _jobTitles)
						{
							<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
						}

					</MudSelect>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.Department == null ? string.Empty : x.Department.Name" Title="Отдел">
				<EditTemplate>
					<MudSelect @bind-Value="context.Item.DepartmentId"
							   Label="Выбор Отдела"
							   Required="false"
							   RequiredError="Нужно выбрать отдел"
							   RelativeWidth="DropdownWidth.Ignore"
							   Variant="Variant.Outlined"
							   Clearable="true"
							   Dense="true">
						@foreach (var item in _departments)
						{
							<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
						}

					</MudSelect>
				</EditTemplate>
			</PropertyColumn>
			@* <PropertyColumn Property="x => x.Department == null ? string.Empty : x.Department.Name" Title="Отдел">
			<EditTemplate>
				<MudAutocomplete @bind-Value="context.Item.Department"
								 T="Department"
								 ToStringFunc="CleanName"
								 SearchFunc="SearchDepartment"
								 Variant="Variant.Outlined"
								 Label="Поиск Отдела (в Схеме предприятия)"
								 Required="false" RequiredError="Нужно выбрать отдел"
								 Clearable="true"
								 Dense="true"
								 RelativeWidth="DropdownWidth.Ignore">
					<ItemTemplate Context="item">
						<MudText Typo="Typo.body2" Style="white-space:nowrap">
							@item.Name
						</MudText>
					</ItemTemplate>
				</MudAutocomplete>
			</EditTemplate>
		</PropertyColumn> *@
			<PropertyColumn Property="x => x.City == null ? string.Empty : x.City.Name" Title="Город">
				<EditTemplate>
					<MudSelect @bind-Value="context.Item.CityId"
							   Label="Выберите Город"
							   Required="false"
							   RequiredError="Нужно выбрать город"
							   Variant="Variant.Outlined"
							   Clearable="true"
							   Dense="true">
						@foreach (var item in _cities)
						{
							<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
						}
					</MudSelect>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.Location == null ? string.Empty : x.Location.Name" Title="Локация" Required="false">
				<EditTemplate>
					<MudSelect @bind-Value="context.Item.LocationId"
							   Label="Выбор Локации"
							   Required="false"
							   RequiredError="Нужно выбрать локацию"
							   Variant="Variant.Outlined"
							   Clearable="true"
							   Dense="true">
						@foreach (var item in _locations)
						{
							<MudSelectItem T="Guid?" Value="item.Id">@item.Name</MudSelectItem>
						}

					</MudSelect>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.UserUt == null ? string.Empty : x.UserUt.Name" Title="Пользователь УТ" Required="false">
				<EditTemplate>
					<MudAutocomplete @bind-Value="context.Item.UserUt"
									 T="UserUt"
									 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Name}" )"
									 SearchFunc="SearchUserUt"
									 Variant="Variant.Outlined"
									 Label="Поиск Пользователя УТ"
									 Clearable="true"
									 Dense="true"
									 RelativeWidth="DropdownWidth.Ignore">
						<ItemTemplate Context="item">
							<MudText Typo="Typo.body2" Style="white-space:nowrap">
								@item.Name
							</MudText>
						</ItemTemplate>
					</MudAutocomplete>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.EmployeeBuh == null ? string.Empty : x.EmployeeBuh.Name" Title="Сотрудник БП" Required="false">
				<CellTemplate>
					@context.Item.EmployeeBuh?.Name
					@(string.IsNullOrEmpty(context.Item.EmployeeBuh?.Code) ? string.Empty : $"({context.Item.EmployeeBuh?.Code})")
				</CellTemplate>
				<EditTemplate>
					<MudAutocomplete @bind-Value="context.Item.EmployeeBuh"
									 T="EmployeeBuh"
									 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Name} ({e.Code})" )"
									 SearchFunc="SearchEmployeeBuh"
									 Variant="Variant.Outlined"
									 Label="Поиск Сотрудника БП"
									 Clearable="true"
									 Dense="true"
									 RelativeWidth="DropdownWidth.Ignore">
						<ItemTemplate Context="item">
							<MudText Typo="Typo.body2" Style="white-space:nowrap">
								@item.Name (@item.Code)
							</MudText>
						</ItemTemplate>
					</MudAutocomplete>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.EmployeeZup == null ? string.Empty : x.EmployeeZup.Name" Title="Сотрудник ЗУП" Required="false">
				<CellTemplate>
					@context.Item.EmployeeZup?.Name
					@(string.IsNullOrEmpty(context.Item.EmployeeZup?.Code) ? string.Empty : $"({context.Item.EmployeeZup?.Code})")
				</CellTemplate>
				<EditTemplate>
					<MudAutocomplete @bind-Value="context.Item.EmployeeZup" FullWidth="true"
									 T="EmployeeZup"
									 ToStringFunc="@(e => e == null ? string.Empty : $"{e.Name} ({e.Code})" )"
									 SearchFunc="SearchEmployeeZup"
									 Variant="Variant.Outlined"
									 Label="Поиск Сотрудника ЗУП"
									 Clearable="true"
									 Dense="true"
									 RelativeWidth="DropdownWidth.Ignore">
						<ItemTemplate Context="item">
							<MudText Typo="Typo.body2" Style="white-space:nowrap">
								@item.Name (@item.Code)
							</MudText>
						</ItemTemplate>
					</MudAutocomplete>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.UserAd == null ? string.Empty : x.UserAd.Name" Title="AD User" Required="false">
				<CellTemplate>
					@context.Item.UserAd?.Name
				</CellTemplate>
				<EditTemplate>
					<MudAutocomplete @bind-Value="context.Item.UserAd" FullWidth="true"
									 T="UserAd"
									 ToStringFunc="@(e => e == null ? string.Empty : e.Name)"
									 SearchFunc="SearchUserAd"
									 Variant="Variant.Outlined"
									 Label="Поиск Пользователя AD"
									 Clearable="true"
									 Dense="true"
									 RelativeWidth="DropdownWidth.Ignore">
						<ItemTemplate Context="item">
							<MudText Typo="Typo.body2" Style="white-space:nowrap">
								@item.Name
							</MudText>
						</ItemTemplate>
					</MudAutocomplete>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.OperationManager == null ? string.Empty : x.OperationManager.Name" Title="Оперативный Руководитель" Required="false">
				<EditTemplate>
					<MudAutocomplete @bind-Value="context.Item.OperationManager" FullWidth="true"
									 T="Employee"
									 ToStringFunc="@(e => e == null ? string.Empty : e.Name)"
									 SearchFunc="SearchEmployee"
									 Variant="Variant.Outlined"
									 Label="Поиск Оперативного Руководителя"
									 Clearable="true"
									 Dense="true"
									 RelativeWidth="DropdownWidth.Ignore">
						<ItemTemplate Context="item">
							<MudText Typo="Typo.body2" Style="white-space:nowrap">
								@item.Name
							</MudText>
						</ItemTemplate>
					</MudAutocomplete>
				</EditTemplate>
			</PropertyColumn>
			<PropertyColumn Property="x => x.LocationManager == null ? string.Empty : x.LocationManager.Name" Title="Руководитель Локации" Required="false">
				<EditTemplate>
					<MudAutocomplete @bind-Value="context.Item.LocationManager" FullWidth="true"
									 T="Employee"
									 ToStringFunc="@(e => e == null ? string.Empty : e.Name)"
									 SearchFunc="SearchEmployee"
									 Variant="Variant.Outlined"
									 Label="Поиск Руководителя Локации"
									 Clearable="true"
									 Dense="true"
									 RelativeWidth="DropdownWidth.Ignore">
						<ItemTemplate Context="item">
							<MudText Typo="Typo.body2" Style="white-space:nowrap">
								@item.Name
							</MudText>
						</ItemTemplate>
					</MudAutocomplete>
				</EditTemplate>
			</PropertyColumn>
			<TemplateColumn Hidden="@(!_isEditingGrid)">
				<CellTemplate>
					<MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Secondary" OnClick="@(() => DeleteItem(context.Item))" />
				</CellTemplate>
				<EditTemplate>
					<MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Small"
							   OnClick="@(() => DeleteItem(context.Item))" Class="mt-3">
						Delete
					</MudButton>
				</EditTemplate>
			</TemplateColumn>
		</Columns>
		<LoadingContent>
			<MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Left">
				Загрузка из БД...
			</MudAlert>
		</LoadingContent>
		<NoRecordsContent>
			<MudText Typo="Typo.h6" Align="Align.Start" Class="pa-4">
				Здесь пока ничего нет. Включите редактирование и нажмите "Добавить", чтобы создать первый!
			</MudText>
		</NoRecordsContent>
		<PagerContent>
			<MudDataGridPager T="Employee" />
		</PagerContent>
	</MudDataGrid>
</MudContainer>

