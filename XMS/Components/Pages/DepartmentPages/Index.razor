@page "/departments"

@using XMS.Components.Common
@using XMS.Modules.Departments.Abstractions
@using XMS.Modules.Departments.Domain
@using XMS.Modules.Employees.Abstractions
@using XMS.Modules.Employees.Domain
@inject IDepartmentService Service;
<MudContainer MaxWidth="MaxWidth.Large">
	<MudStack>
		<MudPaper Class="pa-4" Width="600px">
			<MudStack Row="true">
				<MudText Typo="Typo.h4">Схема предприятия</MudText>
				<MudSpacer />
				@if (_expandedAll)
				{
					<MudFab Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.VerticalAlignCenter" OnClick="CollapseAll" title="Свернуть все" />
				}
				else
				{
					<MudFab Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Expand" OnClick="ExpandAll" title="Развернуть все" />
				}
			</MudStack>
		</MudPaper>

		<MudPaper Width="600px" Elevation="0" Outlined="true">
			<MudTreeView Items="_treeItems" T="Department" Dense="true">
				<ItemTemplate Context="item">
					<MudTreeViewItem @bind-Expanded="@item.Expanded"
									 Items="@item.Children"
									 Value="@item.Value"
									 Text="@item.Value?.Name"
									 Icon="@GetIcon(item)" />
				</ItemTemplate>
			</MudTreeView>
		</MudPaper>
	</MudStack>
</MudContainer>

@code {

	private readonly CancellationTokenSource _cts = new();
	private List<TreeItemData<Department>> _treeItems = new();
	private bool _expandedAll;

	protected override async Task OnInitializedAsync()
	{
		var departments = await Service.GetListAsync(_cts.Token);

		_treeItems = TreeHelper.BuildTree(departments, null);
	}

	private void ExpandAll()
	{
		_treeItems.SetExpansion(true);
		_expandedAll = true;
	}
	private void CollapseAll()
	{
		_treeItems.SetExpansion(false);
		_expandedAll = false;
	}

	private string GetIcon(ITreeItemData<Department> item)
	{
		if (item.HasChildren)
			return item.Expanded ? Icons.Material.Filled.FolderOpen : Icons.Material.Filled.Folder;

		return Icons.Material.Filled.CorporateFare;
	}
}
